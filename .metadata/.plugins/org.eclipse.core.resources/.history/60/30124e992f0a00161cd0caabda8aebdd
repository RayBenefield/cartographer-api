package com.cartographerapi.domain;

import java.util.Collections;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import java.io.IOException;
import com.fasterxml.jackson.databind.JsonNode;

/**
 * Reader repository for PlayerGames from the Halo API.
 * 
 * @see PlayerGamesWriter
 * 
 * @author GodlyPerfection
 *
 */
public class PlayerGamesHaloApiReader implements PlayerGamesReader {

	private Halo5ApiWrapper api;
	private ObjectMapper mapper;
	private Integer total;
	private String lastMatch;

	@Override
	public List<PlayerGame> getPlayerGamesByGamertag(String gamertag) {
		return getPlayerGamesByGamertag(gamertag, 0, 25);
	}

	@Override
	public List<PlayerGame> getPlayerGamesByGamertag(String gamertag, Integer start, Integer count) {
		List<PlayerGame> results = new ArrayList<PlayerGame>();
		try {
			Integer apiStart = total - start - 24;
			if (apiStart < 0) {
				apiStart = 0;
				count = total - start + 1;
			}
			String gamesResult = api.customGames(gamertag, apiStart, count);
			JsonNode root = mapper.readTree(gamesResult);
			Integer lastResult = root.path("ResultCount").asInt();
			if (
				lastMatch != null
				&& !root.path("Results").path(lastResult - 1).path("Id").path("MatchId").asText().equals(lastMatch)
			) {
				return results;
			}
			Integer numberOfGame = start + (count - 1);
			for (JsonNode game : root.path("Results")) {
				PlayerGame newGame = new PlayerGame(gamertag, numberOfGame, game);
				results.add(newGame);
				numberOfGame--;
			}
			Collections.reverse(results);
			if (lastMatch != null) {
				results.remove(0);
			}
		} catch (IOException exception) {
			return null;
		}
		return results;
	}

	/**
	 * Since the Halo API returns most recent first, this allows us to work
	 * backwards from the first game played.
	 * 
	 * @param total
	 */
	public void setTotal(Integer total) {
		this.total = total;
	}

	/**
	 * If results were pulled before check against the last match we found.
	 * 
	 * @param lastMatch
	 */
	public void setLastMatch(String lastMatch) {
		this.lastMatch = lastMatch;
	}
	
    /**
     * The lazy IOC constructor.
     */
	public PlayerGamesHaloApiReader() {
		this.api = new Halo5ApiWrapper();
		this.mapper = new ObjectMapper();
	}

}
