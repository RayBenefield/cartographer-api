package com.cartographerapi.functions;

import com.cartographerapi.domain.ObjectSqsWriter;
import com.cartographerapi.domain.ObjectSnsWriter;
import com.cartographerapi.domain.SegmentScannerRequest;

import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBMapper;
import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBScanExpression;
import com.amazonaws.services.dynamodbv2.datamodeling.ScanResultPage;
import com.amazonaws.services.dynamodbv2.document.internal.InternalUtils;
import com.amazonaws.services.dynamodbv2.AmazonDynamoDBClient; 

import com.amazonaws.services.lambda.runtime.Context;
import com.amazonaws.services.lambda.runtime.RequestHandler;
import com.amazonaws.services.lambda.runtime.events.SNSEvent;

import com.amazonaws.regions.Region;
import com.amazonaws.regions.Regions;

import java.io.IOException;

import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;

import com.fasterxml.jackson.databind.ObjectMapper;

public class SegmentScanner implements RequestHandler<SNSEvent, List<Object>> {

    @Override
    @SuppressWarnings({ "unchecked", "rawtypes" })
    public List<Object> handleRequest(SNSEvent input, Context context) {
        context.getLogger().log("Input: " + input);

        ObjectMapper mapper = new ObjectMapper();
        
        // Figure out who this is for.
		SegmentScannerRequest request;
		try {
			context.getLogger().log(mapper.writeValueAsString(input));
			Map<String, Object> requestMap = mapper.readValue(input.getRecords().get(0).getSNS().getMessage(), HashMap.class);
			request = new SegmentScannerRequest(requestMap);
		} catch (IOException exception) {
			return new ArrayList<Object>();
		}

        List<Object> results = new ArrayList<Object>();
		try {
			AmazonDynamoDBClient client = new AmazonDynamoDBClient();
			client.setRegion(Region.getRegion(Regions.US_WEST_2));
			DynamoDBMapper dbMapper = new DynamoDBMapper(client);
			
			DynamoDBScanExpression scanExpression = new DynamoDBScanExpression()
				.withSegment(request.getSegmentId())
				.withTotalSegments(request.getTotalSegments());
			
			if (request.getLastEvaluatedKey() != null) {
				scanExpression.withExclusiveStartKey(InternalUtils.fromSimpleMap(request.getLastEvaluatedKey()));
			}

			ScanResultPage page = dbMapper.scanPage(Class.forName(request.getDomainObject()), scanExpression);
			List<Object> pageResults = new ArrayList<Object>(page.getResults());
			
			ObjectSqsWriter writer = new ObjectSqsWriter(request.getQueueUrlKey());
			writer.saveObjects(pageResults);

			if (page.getLastEvaluatedKey() != null) {
				context.getLogger().log("LastEvalKey: " + page.getLastEvaluatedKey());
				SegmentScannerRequest scannerInput = new SegmentScannerRequest(request.getSegmentId(), request.getTotalSegments(), request.getDomainObject(), request.getQueueUrlKey());
				scannerInput.setLastEvaluatedKey(InternalUtils.toSimpleMapValue(page.getLastEvaluatedKey()));

				ObjectSnsWriter continueWriter = new ObjectSnsWriter("snsSegmentScannerRequestContinue");
				continueWriter.saveObject(scannerInput);
			}
		} catch (ClassNotFoundException exception) {
			context.getLogger().log("ClassNotFound: " + request.getDomainObject());
		}

        return results;
    }

}
